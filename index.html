<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>画像切り取りカメラ（v18.2 camera fix + 共有体験/クリーンアップ）</title>
<style>
  :root{ --bg:#0b0f14; --fg:#eaf2f7; --muted:#a6b6c4; --accent:#2ecc71; --danger:#e74c3c; --ring:#27ae60; --card:#12181f; }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family: system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;}
  .app{display:flex;flex-direction:column;height:100%;}
  .stage{position:relative;flex:1;overflow:hidden;background:#000;}
  .stage>video,#photo-preview,.stage>canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}
  .bottombar{position:absolute;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px;background:rgba(0,0,0,.5);z-index:20}
  .pill{border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.4);color:#fff;border-radius:999px;padding:10px 14px;font-weight:700}
  .btn-capture{width:84px;height:84px;border-radius:50%;background:#fff;border:6px solid #cfcfcf;}
  .hidden{display:none}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:rgba(0,0,0,.85);color:#fff;padding:10px 14px;border-radius:999px;font-size:14px;opacity:0;transition:opacity .2s ease;pointer-events:none;z-index:50}
  .toast.show{opacity:1}
</style>
</head>
<body>
<div class="app">
  <main class="stage" id="stage">
    <video id="preview" autoplay muted playsinline></video>
    <img id="photo-preview" alt="" class="hidden" />
    <canvas id="overlay"></canvas>
    <div class="bottombar">
      <label id="pick-file" for="file-input" class="pill">📷 写真</label>
      <button id="capture" class="btn-capture"></button>
      <div style="display:flex;gap:8px">
        <button id="resume" class="pill" title="カメラを再開">再開</button>
        <a id="dl" class="pill hidden" download>保存</a>
        <button id="share" class="pill hidden">共有</button>
      </div>
    </div>
  </main>
</div>
<input id="file-input" class="hidden" type="file" accept="image/*" capture="environment" />
<div id="toast" class="toast"></div>
<script>
(function(){
  const $=s=>document.querySelector(s);
  const video=$('#preview');
  const photoPreview=$('#photo-preview');
  const captureBtn=$('#capture');
  const fileInput=$('#file-input');
  const pickFile=$('#pick-file');
  const dl=$('#dl');
  const shareBtn=$('#share');
  const resumeBtn=$('#resume');
  const overlay=$('#overlay');
  const ctx=overlay.getContext('2d');
  const toast=$('#toast');

  let usingPhoto=false,photoObjUrl=null,photoBitmap=null,currentStream=null,latestBlobUrl=null;

  function showToast(msg,ms=2000){ toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),ms); }

  async function startCamera(){
    stopCamera(); usingPhoto=false; updateStageVisual();
    try{
      currentStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
      video.srcObject=currentStream; await video.play();
    }catch(e){console.warn(e); pickFile.classList.remove('hidden');}
  }
  function stopCamera(){if(currentStream){currentStream.getTracks().forEach(t=>t.stop());currentStream=null;}}
  function updateStageVisual(){if(usingPhoto){video.classList.add('hidden');photoPreview.classList.remove('hidden');} else {video.classList.remove('hidden');photoPreview.classList.add('hidden');}}

  resumeBtn.addEventListener('click',()=>{usingPhoto=false;startCamera();updateStageVisual();});

  pickFile.addEventListener('click',()=>fileInput.click());
  fileInput.addEventListener('change',async e=>{
    const file=e.target.files?.[0]; if(!file) return;
    const img=new Image(); img.onload=()=>{photoPreview.src=img.src;usingPhoto=true;stopCamera();updateStageVisual();};
    img.src=URL.createObjectURL(file); photoObjUrl=img.src;
    if(window.createImageBitmap){ try{photoBitmap=await createImageBitmap(file);}catch(_){photoBitmap=null;} }
  });

  captureBtn.addEventListener('click',async()=>{
    try{
      const src=usingPhoto?(photoBitmap||photoPreview):video;
      if(!src){showToast('入力がありません');return;}
      const url=await cropAndExport(src);
      presentOutput(url);
    }catch(e){console.warn(e);showToast('撮影に失敗しました');}
  });

  async function cropAndExport(source){
    const w=source.videoWidth||source.width||source.naturalWidth||1280;
    const h=source.videoHeight||source.height||source.naturalHeight||720;
    const canvas=new OffscreenCanvas(w,h); const ctx2=canvas.getContext('2d');
    ctx2.drawImage(source,0,0,w,h);
    const blob=await canvas.convertToBlob({type:'image/jpeg',quality:0.8});
    const url=URL.createObjectURL(blob); latestBlobUrl=url; return url;
  }

  function presentOutput(url){
    const ts=new Date(); const pad=n=>String(n).padStart(2,'0');
    const filename=`IMG_${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}${pad(ts.getSeconds())}.jpg`;
    dl.href=url; dl.download=filename; dl.classList.remove('hidden');
    enableShare(url,filename);
    // 自動共有体験: 端末が対応していれば即共有
    maybeShare(url,filename);
  }

  async function enableShare(url,filename){
    try{
      const resp=await fetch(url); const blob=await resp.blob();
      const file=new File([blob],filename,{type:blob.type});
      if(navigator.canShare && navigator.canShare({files:[file]})){
        shareBtn.classList.remove('hidden');
        shareBtn.onclick=async()=>{await doShare(file);};
      }
    }catch(_){shareBtn.classList.add('hidden');}
  }

  async function maybeShare(url,filename){
    try{
      const resp=await fetch(url); const blob=await resp.blob();
      const file=new File([blob],filename,{type:blob.type});
      if(navigator.canShare && navigator.canShare({files:[file]})){
        await doShare(file);
      }
    }catch(e){console.warn(e);}
  }

  async function doShare(file){
    try{ await navigator.share({files:[file],title:'画像'}); cleanupAfterOutput('共有しました'); }
    catch(e){ /* cancel → ignore */ }
  }

  dl.addEventListener('click',()=>{setTimeout(()=>cleanupAfterOutput('保存しました'),800);});

  function cleanupAfterOutput(msg){
    if(latestBlobUrl){try{URL.revokeObjectURL(latestBlobUrl);}catch(_){}} latestBlobUrl=null;
    dl.classList.add('hidden'); shareBtn.classList.add('hidden');
    showToast(msg);
  }

  startCamera();
})();
</script>
</body>
</html>
