<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>画像切り取りカメラ（Simple + BottomSheet v18.1）</title>
<meta name="theme-color" content="#0b0f14" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="manifest" href="manifest.webmanifest" />
<style>
  :root{ --bg:#0b0f14; --fg:#eaf2f7; --muted:#a6b6c4; --accent:#2ecc71; --danger:#e74c3c; --ring:#27ae60; --card:#12181f; }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family: system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;}
  .app{display:flex;flex-direction:column;height:100%;}
  /* Stage */
  .stage{position:relative;flex:1;min-height:42vh;overflow:hidden;background:#000;}
  .stage>video,#photo-preview,.stage>canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}
  .flash{position:absolute;inset:0;background:#fff;opacity:0;pointer-events:none;transition:opacity .12s ease-out;}
  /* Top bar */
  .topbar{position:absolute;top:calc(env(safe-area-inset-top) + 8px);left:0;right:0;display:flex;align-items:center;justify-content:space-between;padding:0 12px;z-index:20}
  .title{font-weight:700;font-size:16px;opacity:.85}
  .icon-btn{border:none;background:rgba(0,0,0,.45);color:#fff;padding:10px;border-radius:999px;backdrop-filter:blur(4px);font-size:16px;}
  /* Bottom main controls */
  .bottombar{position:absolute;left:0;right:0;bottom:0;z-index:20;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 16px calc(12px + env(safe-area-inset-bottom));background:linear-gradient(180deg,transparent,rgba(0,0,0,.35) 35%, rgba(0,0,0,.6));}
  .pill{border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.4);color:#fff;border-radius:999px;padding:10px 14px;font-weight:700}
  .btn-capture{width:84px;height:84px;border-radius:50%;background:#fff;border:6px solid #cfcfcf;box-shadow:0 4px 16px rgba(0,0,0,.35)}
  .btn-capture:active{transform:scale(.94);border-color:#9e9e9e}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,.2)}
  .hidden{display:none}
  /* Bottom sheet */
  .sheet{position:fixed;left:0;right:0;bottom:0;transform:translateY(100%);transition:transform .28s ease;z-index:30;background:var(--card);border-top-left-radius:16px;border-top-right-radius:16px;box-shadow:0 -8px 24px rgba(0,0,0,.45);}
  .sheet.open{transform:translateY(0)}
  .sheet .grab{width:42px;height:4px;background:#3a4654;border-radius:999px;margin:10px auto}
  .sheet .section{padding:8px 16px 14px;border-top:1px solid rgba(255,255,255,.06)}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .label{font-size:13px;color:var(--muted)}
  .chip{border-radius:14px;border:1px solid rgba(255,255,255,.18);background:#19212c;color:var(--fg);font-weight:700;padding:10px 12px}
  .chip[data-active="true"]{outline:2px solid var(--ring);background:rgba(46,204,113,.12)}
  .toggle{border-radius:12px;border:1px solid rgba(255,255,255,.18);background:#19212c;color:var(--fg);padding:10px 12px}
  .toggle[data-active="true"]{outline:2px solid var(--ring);background:rgba(46,204,113,.12)}
  .toggle.warn[data-active="true"]{outline-color:#f1c40f}
  /* Toast & spinner */
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(16px + env(safe-area-inset-bottom));background:rgba(0,0,0,.85);color:#fff;padding:10px 14px;border-radius:999px;font-size:14px;box-shadow:0 4px 16px rgba(0,0,0,.35);opacity:0;transition:opacity .2s ease;pointer-events:none;z-index:50}
  .toast.show{opacity:1}
  .spinner-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:40}
  .spinner-backdrop.show{display:flex}
  .spinner{width:56px;height:56px;border-radius:50%;border:6px solid rgba(255,255,255,.35);border-top-color:#fff;animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="app">
  <main class="stage" id="stage">
    <video id="preview" autoplay muted playsinline></video>
    <img id="photo-preview" alt="" class="hidden" />
    <canvas id="overlay"></canvas>
    <div id="flash" class="flash"></div>

    <!-- Top bar -->
    <div class="topbar">
      <div class="title">画像切り取りカメラ</div>
      <button id="open-settings" class="icon-btn" aria-label="設定を開く">⚙</button>
    </div>

    <!-- Bottom primary controls -->
    <div class="bottombar">
      <label id="pick-file" for="file-input" class="pill" aria-label="写真から読み込む">📷 写真</label>
      <button id="capture" class="btn-capture" aria-label="撮影"></button>
      <div style="display:flex;gap:8px">
        <button id="resume-camera" class="pill ghost hidden">再開</button>
        <a id="dl" class="pill ghost hidden" download>保存</a>
        <button id="share" class="pill ghost hidden">共有</button>
      </div>
    </div>
  </main>
</div>

<!-- Hidden inputs -->
<input id="file-input" class="hidden" type="file" accept="image/*" capture="environment" />

<!-- Bottom Sheet (詳細設定) -->
<section id="sheet" class="sheet" aria-hidden="true">
  <div class="grab"></div>
  <div class="section">
    <div class="label">丸枠サイズ</div>
    <div class="row" id="size-row">
      <button class="chip" data-size="0.35" data-active="true">S</button>
      <button class="chip" data-size="0.42">M</button>
      <button class="chip" data-size="0.50">L</button>
    </div>
  </div>
  <div class="section">
    <div class="row">
      <button id="grid" class="toggle" data-active="true">グリッド</button>
      <button id="lock" class="toggle warn" data-active="false" title="ドラッグ無効">ロック</button>
      <button id="recenter" class="toggle">中央に戻す</button>
      <button id="fit-inside" class="toggle" data-active="true" title="丸枠を映像内に制限">枠のはみ出し防止</button>
    </div>
  </div>
  <div class="section">
    <div class="label">注意</div>
    <div style="font-size:12px;color:var(--muted);line-height:1.5">
      ・iPhone/SafariはHTTPS接続が必要です。<br/>
      ・保存/共有は端末とブラウザの対応状況に依存します。
    </div>
  </div>
</section>

<!-- Toast / Spinner -->
<div id="toast" class="toast" aria-live="polite">保存しました</div>
<div id="spinner" class="spinner-backdrop" role="alert"><div class="spinner"></div></div>

<script>
(function(){
  // ===== Helpers =====
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const setActive = (el,on)=>{ if(!el) return; el.dataset.active = on?"true":"false"; }
  const isActive = el => el?.dataset?.active === 'true';
  const formatTS = d=>{const z=n=>String(n).padStart(2,'0');return d.getFullYear()+z(d.getMonth()+1)+z(d.getDate())+'_'+z(d.getHours())+z(d.getMinutes())+z(d.getSeconds())}

  // Elements
  const stage = $('#stage');
  const video = $('#preview');
  const overlay = $('#overlay');
  const ctx = overlay.getContext('2d');
  const photoPreview = $('#photo-preview');
  const flash = $('#flash');
  const captureBtn = $('#capture');
  const dl = $('#dl');
  const shareBtn = $('#share');
  const resumeBtn = $('#resume-camera');
  const fileInput = $('#file-input');
  const pickFile = $('#pick-file');
  const sheet = $('#sheet');
  const openSettings = $('#open-settings');

  // Toggles
  const gridBtn = $('#grid');
  const lockBtn = $('#lock');
  const recenterBtn = $('#recenter');
  const fitBtn = $('#fit-inside');

  // Size chips
  const sizeChips = $$(".chip[data-size]");

  // State
  let showGrid = true;
  let radiusPct = 0.35; // default S
  let cxNorm = 0.5, cyNorm = 0.5;
  let usingPhoto = false, photoObjUrl = null, photoBitmap = null;
  let currentStream = null, track = null, caps=null, settings=null;
  let fitInside = true, locked = false;
  let latestBlobUrl = null;

  // Persist
  const LS = { get(k,d=null){try{const v=localStorage.getItem(k);return v===null?d:JSON.parse(v)}catch(_){return d}}, set(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(_){}} };
  function saveState(){
    const activeChip = document.querySelector('.chip[data-active="true"]');
    const activeSize = activeChip ? activeChip.dataset.size : null;
    LS.set('settings',{cx:cxNorm,cy:cyNorm,radiusPct,showGrid:isActive(gridBtn),fitInside:isActive(fitBtn),locked,activeSize});
  }
  function restoreState(){
    const s = LS.get('settings',{});
    if(typeof s.cx==='number') cxNorm=s.cx; if(typeof s.cy==='number') cyNorm=s.cy;
    if(typeof s.radiusPct==='number') radiusPct=s.radiusPct;
    if(typeof s.showGrid==='boolean'){ showGrid=s.showGrid; setActive(gridBtn,showGrid);} 
    if(typeof s.fitInside==='boolean'){ fitInside=s.fitInside; setActive(fitBtn,fitInside);} 
    if(typeof s.locked==='boolean'){ locked=s.locked; setActive(lockBtn,locked);} 
    if(s.activeSize){ sizeChips.forEach(b=>{ if(b.dataset.size===String(s.activeSize)){ markActiveChip(b); radiusPct=parseFloat(b.dataset.size);} }); }
  }

  // UI: sheet
  function openSheet(){ sheet.classList.add('open'); sheet.setAttribute('aria-hidden','false'); }
  function closeSheet(){ sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true'); }
  openSettings.addEventListener('click', ()=>{ if(sheet.classList.contains('open')) closeSheet(); else openSheet(); });
  sheet.addEventListener('click', (e)=>{ if(e.target===sheet) closeSheet(); });

  // Toast / spinner
  const toastEl = $('#toast');
  const spinnerEl = $('#spinner');
  function showToast(msg,ms=2000){ toastEl.textContent=msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),ms); }
  function spinner(on){ if(on) spinnerEl.classList.add('show'); else spinnerEl.classList.remove('show'); }

  // Size chips handlers
  function markActiveChip(target){ $$('.chip[data-size]').forEach(b=>b.setAttribute('data-active','false')); if(target) target.setAttribute('data-active','true'); }
  sizeChips.forEach(btn=>{
    btn.addEventListener('click',()=>{ const v=parseFloat(btn.dataset.size); if(Number.isFinite(v)){ radiusPct=v; markActiveChip(btn); saveState(); }});
  });

  // Buttons
  gridBtn.addEventListener('click',()=>{ setActive(gridBtn,!isActive(gridBtn)); showGrid=isActive(gridBtn); saveState(); });
  lockBtn.addEventListener('click',()=>{ locked=!locked; setActive(lockBtn,locked); saveState(); });
  recenterBtn.addEventListener('click',()=>{ cxNorm=.5; cyNorm=.5; saveState(); });
  fitBtn.addEventListener('click',()=>{ fitInside=!fitInside; setActive(fitBtn,fitInside); saveState(); });

  // Pointer to move circle
  overlay.addEventListener('pointerdown',e=>{ if(locked) return; overlay.setPointerCapture(e.pointerId); moveToPointer(e); });
  overlay.addEventListener('pointermove',e=>{ if(locked) return; if(e.pressure>0) moveToPointer(e); });
  overlay.addEventListener('pointerup',e=>{ if(locked) return; overlay.releasePointerCapture(e.pointerId); });
  function moveToPointer(e){ const r=overlay.getBoundingClientRect(); const x=(e.clientX-r.left)/r.width; const y=(e.clientY-r.top)/r.height; cxNorm=clamp(x,0,1); cyNorm=clamp(y,0,1); }

  // Camera
  async function startCamera(){
    stopCamera(); usingPhoto=false; updateStageVisual();
    try{
      const constraints={ audio:false, video:{ facingMode:{ideal:'environment'}, width:{ideal:1920}, height:{ideal:1080}, frameRate:{ideal:30}, advanced:[{focusMode:'continuous'},{exposureMode:'continuous'}] } };
      currentStream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject=currentStream; await video.play();
      track=currentStream.getVideoTracks()[0];
      try{ caps=track.getCapabilities?.()||null; settings=track.getSettings?.()||null; }catch(_){ }
      requestAnimationFrame(drawOverlay);
    }catch(err){
      console.warn('getUserMedia failed',err);
      pickFile.classList.remove('hidden');
      const isHTTPS = location.protocol==='https:'||['localhost','127.0.0.1'].includes(location.hostname);
      let msg='カメラの起動に失敗しました。';
      if(!isHTTPS) msg+='\n・iPhone/SafariはHTTPSでアクセスしてください';
      if(err && err.name==='NotAllowedError') msg+='\n・ブラウザ設定でカメラ許可をONにしてください';
      msg+='\n・「写真」読み込みで代替できます';
      showToast(msg,4000);
    }
  }
  function stopCamera(){ if(currentStream){ currentStream.getTracks().forEach(t=>t.stop()); currentStream=null; track=null; } }

  // Overlay drawing
  function updateOverlaySize(){ overlay.width = stage.clientWidth; overlay.height = stage.clientHeight; }
  function displayedDrawRect(){
    const vw = video.videoWidth||1280, vh = video.videoHeight||720; const cw = stage.clientWidth, ch = stage.clientHeight;
    const scale = Math.max(cw/vw, ch/vh); const drawW = vw*scale, drawH = vh*scale; const offsetX=(cw-drawW)/2, offsetY=(ch-drawH)/2;
    return {vw,vh,scale,drawW,drawH,offsetX,offsetY};
  }
  function drawOverlay(){
    updateOverlaySize(); const w=overlay.width, h=overlay.height; ctx.clearRect(0,0,w,h);
    let r = Math.min(w,h) * radiusPct; let cx = cxNorm*w, cy = cyNorm*h;
    if(fitInside){ const {drawW,drawH,offsetX,offsetY} = displayedDrawRect();
      const minX=Math.max(r, offsetX + r), maxX=Math.min(w - r, offsetX + drawW - r);
      const minY=Math.max(r, offsetY + r), maxY=Math.min(h - r, offsetY + drawH - r);
      cx = clamp(cx, minX, maxX); cy = clamp(cy, minY, maxY); cxNorm = clamp(cx / w, 0, 1); cyNorm = clamp(cy / h, 0, 1);
    }
    // Dim
    ctx.save(); ctx.fillStyle='rgba(0,0,0,.6)'; ctx.fillRect(0,0,w,h); ctx.globalCompositeOperation='destination-out'; ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill(); ctx.restore();
    // Ring
    ctx.save(); ctx.strokeStyle = locked ? '#f1c40f' : '#00FF66'; ctx.lineWidth=4; ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.stroke();
    if(locked){ ctx.font=Math.max(16,Math.floor(r*.25))+'px system-ui,-apple-system,Segoe UI,Roboto'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillStyle='#f1c40f'; ctx.fillText('🔒', cx + r*0.65, cy - r*0.65); }
    if(showGrid){ ctx.strokeStyle='rgba(255,255,255,.95)'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(cx-r,cy); ctx.lineTo(cx+r,cy); ctx.moveTo(cx,cy-r); ctx.lineTo(cx,cy+r); const rr=r/Math.SQRT2; ctx.moveTo(cx-rr,cy-rr); ctx.lineTo(cx+rr,cy+rr); ctx.moveTo(cx-rr,cy+rr); ctx.lineTo(cx+rr,cy-rr); ctx.stroke(); }
    ctx.restore();
    requestAnimationFrame(drawOverlay);
  }

  // Capture flow
  const OUTPUT_SIZE = 1080;
  function flashOnce(){ flash.style.opacity='0.7'; setTimeout(()=>flash.style.opacity='0',120); }
  captureBtn.addEventListener('click', async ()=>{ spinner(true); flashOnce(); try{
    if(usingPhoto && photoBitmap){ await captureFromBitmap(photoBitmap); }
    else if(video.videoWidth && video.videoHeight && currentStream){ await captureFromVideo(); }
    else if(fileInput.files?.[0]){ const bmp = await loadBitmap(fileInput.files[0]); await captureFromBitmap(bmp); }
    else{ alert('カメラまたは画像が利用できません。'); }
  }catch(e){ console.warn('capture failed',e); } finally{ spinner(false); }});

  async function captureFromVideo(){
    const {vw, vh, scale, drawW, drawH, offsetX, offsetY} = displayedDrawRect();
    const cxDisp=cxNorm*stage.clientWidth, cyDisp=cyNorm*stage.clientHeight, rDisp=Math.min(stage.clientWidth,stage.clientHeight)*radiusPct;
    const cxSrc=(cxDisp-offsetX)/scale, cySrc=(cyDisp-offsetY)/scale, rSrc=rDisp/scale; const url = await cropAndExport(video, vw, vh, cxSrc, cySrc, rSrc); presentDownload(url);
  }
  async function captureFromBitmap(bmp){
    const vw = (bmp.width||bmp.naturalWidth), vh=(bmp.height||bmp.naturalHeight); const cw=stage.clientWidth, ch=stage.clientHeight; const scale=Math.max(cw/vw, ch/vh);
    const drawW=vw*scale, drawH=vh*scale, offsetX=(cw-drawW)/2, offsetY=(ch-drawH)/2; const cxDisp=cxNorm*cw, cyDisp=cyNorm*ch, rDisp=Math.min(cw,ch)*radiusPct;
    const cxSrc=(cxDisp-offsetX)/scale, cySrc=(cyDisp-offsetY)/scale, rSrc=rDisp/scale; const url = await cropAndExport(bmp, vw, vh, cxSrc, cySrc, rSrc); presentDownload(url);
  }
  async function cropAndExport(source, vw, vh, cxSrc, cySrc, rSrc){
    const x1=Math.max(0,Math.floor(cxSrc-rSrc)), y1=Math.max(0,Math.floor(cySrc-rSrc)), x2=Math.min(vw,Math.ceil(cxSrc+rSrc)), y2=Math.min(vh,Math.ceil(cySrc+rSrc));
    const sw=x2-x1, sh=y2-y1; const side=Math.max(sw,sh);
    const square=new OffscreenCanvas(side,side); const sctx=square.getContext('2d',{alpha:false}); sctx.fillStyle='#000'; sctx.fillRect(0,0,side,side);
    const dx=Math.floor((side-sw)/2), dy=Math.floor((side-sh)/2); sctx.drawImage(source,x1,y1,sw,sh,dx,dy,sw,sh);
    sctx.save(); sctx.globalCompositeOperation='destination-in'; sctx.beginPath(); sctx.arc(side/2,side/2,Math.min(sw,sh)/2,0,Math.PI*2); sctx.fill(); sctx.restore();

    const out = new OffscreenCanvas(OUTPUT_SIZE, OUTPUT_SIZE); const octx = out.getContext('2d',{alpha:false});
    octx.imageSmoothingQuality='high'; octx.drawImage(square,0,0,OUTPUT_SIZE,OUTPUT_SIZE);
    const blob = await out.convertToBlob({type:'image/jpeg', quality:0.9}); const url = URL.createObjectURL(blob); latestBlobUrl=url; return url;
  }
  function presentDownload(url){ const ts=formatTS(new Date()); const filename=`CTMRI_${ts}.jpg`; dl.href=url; dl.download=filename; dl.classList.remove('hidden'); showToast('保存しました：'+filename); enableShare(url,filename); try{ const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); }catch(_){}
  }

  // File input / photo mode
  pickFile.addEventListener('click',()=>fileInput.click());
  fileInput.addEventListener('change', async (e)=>{ const file=e.target.files?.[0]; if(!file) return; try{ const bmp=await loadBitmap(file); if(photoObjUrl){try{URL.revokeObjectURL(photoObjUrl)}catch(_){}} photoObjUrl=URL.createObjectURL(file); photoPreview.src=photoObjUrl; usingPhoto=true; stopCamera(); updateStageVisual(); photoBitmap=bmp; requestAnimationFrame(drawOverlay); }catch(err){ console.warn('photo load failed',err); alert('画像の読み込みに失敗しました。別の写真でお試しください。'); }});
  function updateStageVisual(){ if(usingPhoto){ video.classList.add('hidden'); photoPreview.classList.remove('hidden'); resumeBtn?.classList.remove('hidden'); } else { video.classList.remove('hidden'); photoPreview.classList.add('hidden'); resumeBtn?.classList.add('hidden'); } }
  async function loadBitmap(file){ if(window.createImageBitmap){ try{ return await window.createImageBitmap(file); }catch(_){ } } return await new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=rej; img.src=URL.createObjectURL(file); }); }

  // Web Share (files)
  async function enableShare(url, filename){ if(!shareBtn) return; try{ const resp=await fetch(url); const blob=await resp.blob(); const file=new File([blob], filename||'image.jpg', {type: blob.type||'image/jpeg'}); const can=(navigator.canShare && navigator.canShare({files:[file]})); if(can){ shareBtn.classList.remove('hidden'); shareBtn.onclick= async ()=>{ try{ await navigator.share({files:[file], title:'画像'}); }catch(e){} }; } }catch(_){}
  }

  // Resume to camera
  resumeBtn?.addEventListener('click', async ()=>{
    try{
      usingPhoto=false;
      if(photoObjUrl){ try{ URL.revokeObjectURL(photoObjUrl); }catch(_){} photoObjUrl=null; }
      photoPreview.src='';
      photoBitmap=null;
      await startCamera();
      updateStageVisual();
      showToast('カメラを再開しました');
    }catch(e){ console.warn('resume failed', e); }
  });

  // Init
  restoreState();
  if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia){ const isHTTPS = location.protocol==='https:'||['localhost','127.0.0.1'].includes(location.hostname); if(!isHTTPS) showToast('iPhone/SafariではHTTPS接続が必要です',3000); startCamera(); } else { pickFile.classList.remove('hidden'); showToast('この端末ではカメラAPIが利用できません。写真から読み込んでください',3500); }

  // Keyboard micro-adjust
  document.addEventListener('keydown',e=>{ if(e.key==='ArrowUp') cyNorm=clamp(cyNorm-.01,0,1); if(e.key==='ArrowDown') cyNorm=clamp(cyNorm+.01,0,1); if(e.key==='ArrowLeft') cxNorm=clamp(cxNorm-.01,0,1); if(e.key==='ArrowRight') cxNorm=clamp(cxNorm+.01,0,1); });
})();
</script>
</body>
</html>
