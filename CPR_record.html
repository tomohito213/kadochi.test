<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>CPR Record</title>
  <style>
    body {
      background-color: #87ceeb;
      font-family: "MS Gothic", sans-serif;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    .section {
      margin-bottom: 20px;
      padding: 10px;
      background: #00bfff;
      border-radius: 8px;
    }
    button, input, select {
      margin: 5px;
      font-weight: bold;
    }
    #log {
      width: 100%;
      height: 200px;
    }
    .timer-display {
      font-size: 24px;
      font-weight: bold;
      background: lightgreen;
      padding: 10px;
      text-align: center;
      margin: 10px 0;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h1>CPR Record</h1>

  <div>
    <div id="date"></div>
    <div id="clock" class="timer-display"></div>
  </div>

  <div class="section">
    <button onclick="logEvent('記録開始')">記録開始</button>
    <button onclick="logEvent('記録停止')">記録停止</button>
    <button onclick="clearLog()">前回の記録を消去</button>
    <button onclick="downloadLog()">記録表をダウンロード</button>
  </div>

  <div class="section">
    <div class="timer-display" id="rhythmTimer">02:00</div>
    <button onclick="startRhythmCheck()">リズムチェック開始</button>
    <button onclick="resetRhythmTimer()">リセット</button><br>
    <button onclick="logEvent('リズムチェック：Asys')">Asys</button>
    <button onclick="logEvent('リズムチェック：PEA')">PEA</button>
    <button onclick="logEvent('リズムチェック：VF')">VF</button>
    <button onclick="logEvent('リズムチェック：ROSC')">ROSC</button>
  </div>

  <div class="section">
    <label>除細動(J):</label>
    <select onchange="logEvent('DC: ' + this.value + 'J 選択')">
      <option disabled selected>選択</option>
      <option value="120">120</option>
      <option value="150">150</option>
      <option value="200">200</option>
      <option value="360">360</option>
    </select>
    <button onclick="logEvent('ショックを実施しました')">ショック</button>
  </div>

  <div class="section">
    <div class="timer-display" id="epiTimer">04:00</div>
    <button onclick="startEpiTimer()">アドレナリン投与スタート</button>
    <button onclick="resetEpiTimer()">リセット</button><br>
    <button onclick="logEvent('アドレナリン投与 +1')">アドレナリン投与</button>
    <button onclick="logEvent('アドレナリン投与 修正 -1')">修正（-1）</button>
  </div>

  <div class="section">
    <label>VT/VF治療薬:</label>
    <select onchange="logEvent(this.value + 'を選択')">
      <option disabled selected>選択</option>
      <option value="アミオダロン">アミオダロン</option>
      <option value="リドカイン">リドカイン</option>
    </select>
    <button onclick="logEvent('VT/VF治療薬を投与')">薬剤投与</button>
  </div>

  <textarea id="log" readonly></textarea>

  <script>
    let logBox = document.getElementById("log");
    const rhythmDisplay = document.getElementById("rhythmTimer");
    const epiDisplay = document.getElementById("epiTimer");
    let rhythmSec = 120;
    let epiSec = 240;
    let rhythmInterval = null;
    let epiInterval = null;

    function updateClock() {
      const now = new Date();
      document.getElementById("clock").textContent = now.toLocaleTimeString();
      document.getElementById("date").textContent = now.toLocaleDateString();
    }
    setInterval(updateClock, 1000);
    updateClock();

    function logEvent(text) {
      const now = new Date().toLocaleString();
      logBox.value += `${now}  ${text}\n`;
      logBox.scrollTop = logBox.scrollHeight;
    }

    function clearLog() {
      logBox.value = "";
    }

    function downloadLog() {
      const blob = new Blob([logBox.value], { type: "text/plain" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "CPR_record.txt";
      a.click();
    }

    function formatTimer(sec) {
      const m = String(Math.floor(sec / 60)).padStart(2, '0');
      const s = String(sec % 60).padStart(2, '0');
      return `${m}:${s}`;
    }

    function startRhythmCheck() {
      clearInterval(rhythmInterval);
      rhythmSec = 120;
      logEvent("リズムチェック開始");
      rhythmInterval = setInterval(() => {
        rhythmSec--;
        if (rhythmSec <= 0) {
          clearInterval(rhythmInterval);
          rhythmDisplay.textContent = "リズムチェック\nしてください";
        } else {
          rhythmDisplay.textContent = formatTimer(rhythmSec);
        }
      }, 1000);
    }

    function resetRhythmTimer() {
      clearInterval(rhythmInterval);
      rhythmSec = 120;
      rhythmDisplay.textContent = formatTimer(rhythmSec);
    }

    function startEpiTimer() {
      clearInterval(epiInterval);
      epiSec = 240;
      logEvent("アドレナリン投与までの時間計測開始");
      epiInterval = setInterval(() => {
        epiSec--;
        if (epiSec <= 0) {
          clearInterval(epiInterval);
          epiDisplay.textContent = "アドレナリンを\n投与してください";
        } else {
          epiDisplay.textContent = formatTimer(epiSec);
        }
      }, 1000);
    }

    function resetEpiTimer() {
      clearInterval(epiInterval);
      epiSec = 240;
      epiDisplay.textContent = formatTimer(epiSec);
    }
  </script>
</body>
</html>
